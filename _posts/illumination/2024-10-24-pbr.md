---
layout: page
title:  "PBR理论"
author: mosfet
category: illumination
tags: 着色 全局照明 理论
---

---
#### 14. 积分
采样是从空间`S`中随机获得某个样本的(例如位置、球方向)的过程。  
我们可以为这些随机值(即对应空间中的特定点)分配密度，即一些`密度函数(density function)`来强调采样不同地方的可能性。  
本章提供了此类概率运算的机制。这些技术对于使用蒙特卡洛积分对复杂积分进行数值计算也很有用，本章也将对此进行介绍。  
```ruby
# 译者注：常见形式
1 ∫y1..y2|(∫x1..x2|f(x,y)dx)dy
∫y1..y2|(∫f1(y)..f2(y)|f(x,y)dx)dy

2 ∫∫R|f(x,y)dA
# 如果将"通常情况下"该微面即将乘以的参数曲面高度 设定为常量1，(令函数等于1)
# 这里的一个事实是，体积高度为1长方体，和纯粹的面积没有任何区别。
# 这意味着二重积分的
∫∫R|1dA
# 形式，可表示对域的面积进行求和。
```
```ruby
Area(S) =∫S|dA       #如前所述
Area(R) =∫R|dμ       #由于A通常表示二维微面，用μ表示其他的测量基本格
```
如前所述，现在我们可以通过**积分微面的概念**或**积分任何测量基本格**找出给定域的度量，例如微面->面积。  
也可以单独来讨论度量函数`f: S-> value`，它仅仅是根据度量集输出为一个值，意味长度、面积等等。  
另一种记号是要强调每块微面的独特性或者与采样点的联系，例如`Area(S) = ∫x{S}|dA(x)`。这种写法是原书中的规定完全等价的形式，但很冗长，译者会平衡删除部分此形式。  
所有符号术语问题都在本节中讨论并在之后视为默认。  

图形学中求解此类积分不是分析的，如果微积分技巧已经消失，请不要担心，因为我们通常必须对积分进行数值近似，而这只需要一些简单的技术，本章稍后将介绍这些技术。  

**配重(weighted)函数**  
对于一个面积S的测量，可在积分中加入一个非负配重函数来产生新的测量。
```ruby
∫x{(0..1)^2}| dA(x)
          -> length_squared(x)dA(x) # 这称为径向配重，该值等于域向量的长度平方

          # 配重是本文中才第一次出现的数学术语，尚不清楚它应该被归属于哪个领域，可能是概率论。
# 如果您希望分析方法并采取正常形式，它的折返如下
∫x=1..0|∫y=0..1|(x^2+y^2) dxdy

# 译者注：如果您将他视为正常的积分，则结果表示体积，而不必是什么配重后的面积……作为见解差异的参考
```

**通过配重积分比找出配重函数的平均值**  
现在我们可以比较具有配重`f`的积分以及无配重时的比率。  
两个积分值分别是其**测量的域的面积结果**(其中一个被配重)，使用的域和测量的基本格(微面dA)相同。对于其他不同的测量格，记为`dμ(x)`(现在始终视为dA微面)。  
一开始可能很难理解，但这表示新面积比原来测量的面积总体上平均地扩大或缩小的倍数。  
如果我们拿出`f(x)+f(x2)... / 1+1+1`，这可以表征f的某种平均值，你的理解。  
```ruby
average(f(x)) = ∫x{S}f(x)dA(x)
                -----------
                ∫x{S}1dA(x)

# 例如，S=(0..2)^2, f(x)= x^2(仅x，非域) ->  4/3
```
这解释了一种寻求函数平均值的方法。当然，我们必须选择一个合适的测量格，例如微面以及测量的位置。  

**连续性概率(Continuous Probability)**  
随机量`x`(纯量、向量)(在空间中连续地)取出某个值时，行为完全由值的分布来描述。  
该值分布以与此变量相关(或者说与这些值相关)的`概率密度函数(probability density function)`**x~`p`**定量描述。  
`x`在特定取值范围抽出任意样本的概率是它们的密度概率的和，即以下积分：  
```ruby
Prob(v1..v2) = ∫v1..v2 | p(x)dx # 相当于求和概率
# p描述了随机变量取某个值的相对可能性。如果函数的返回值是两倍，则相对有两倍概率

# PDF有两个属性
p(x) >= 0
∫INF| p(x)dx = 1 # 概率之和为1(各种事件)
```

**望值**  
具有PDF分布`p`的随机变量函数`f`的平均值称为它的`预期/期望值(expected value)`，记为  
```ruby
E(f(x)) = ∫f(x)p(x)dx
E(x)    = ∫x*p(x)dx

# 译者注： 只看这些公式可能很抽象，特别是要注意其中的密度函数p(x)，
# 如果我们直接 求和 1p(1)+.. 这些项，密度函数已经处理了所有分配并最后提出平均值
# 因此，该不需要此积分除以某个数
```
所以一个随机变量的期望值可通过该公式`E(x)`得到。期望值有一个令人惊讶且有用的属性，两个随机变量之和的期望值是这些变量的期望值之和：  
```ruby
# 对于随机变量y和y
E(x+y) = E(x) + E(y)
# 因为随机变量的函数本身就是随机变量，所以这种期望的线性也适用于它们：  
E(fx + gy) = Efx + Egy
```
问题是如果求和的随机变量是相关的（不独立），这个属性是否成立？事实上，无论变量是否独立，这种线性属性都成立！此求和属性对于大多数蒙特卡洛应用至关重要。

**多维随机变量**  
对随机变量及其期望值的讨论自然延伸到多维空间。许多照明问题都是在半球表面上表述的。如果我们在此空间定义类似的高维测量格`μ`，则我们理论的适用情况与一维基本类似。  
假设空间S有相关的测量`μ`；例如`S`是球体的表面积，μ测量面积。我们可以定义一个pdf: S->eachProb，随机向量`x~p`，那么向量在某个区域`Si{S}`中取值的概率由积分给出：  
```ruby
Prob(x{Si}) = ∫Si| p(x)dμ
```
这里的概率（事件）是事件为真的概率，因此积分是在子区域Si中取值的概率。  
图形学中S通常是一个面积dμ=dA=dxdy或一组方向dμ=dω=sinθ dθdφ。  

举个例子，二维随机变量`α`是半径为R的圆盘上均匀分布的随机变量。这里均匀意味着面积均匀，例如，糟糕的飞镖运动员的命中在飞镖板上的分布方式。由于它是均匀的，我们知道p(α)是某个常数。根据圆盘面积为Pir^2且总概率为1的事实，我们可以推出：  
```ruby
p(α) = 1/ PiR^2    # 每个位置具有相同的平均概率
# 这意味着α在磁盘的某个子集S1中的概率为，
Prob(α{S1}) = ∫S1 1/PiR^2 dA.

# 这一切都非常抽象。为了实际使用这些信息，我们需要可以计算的形式的积分
# 假设Si是圆盘上比周边更靠近中心的部分
# 如果转换为极位系(polar coordinates)，则α表示为(r, φ)对，S1为 r<R/2 的区域
# 请注意，仅仅因为α是均匀的，并不意味着φ或r一定是均匀的（事实上，φ是均匀的，而r是不均匀的）。
# 微面dA就是r dr dφ
# 因此
Probability(r < R/2) = ∫0..2pi∫0..R/2 1/piR^2 rdrdφ = 0.25
```
函数的期望值的公式适用于多维情况。  
```ruby
E(f(x)) = ∫S|f(x)p(x)dμ
# 其中
x{S}, f: S->f && p: S->prob

# 例如，在单位正方形
S=0..1^2 && f(x,y)=x && p(x, y)=4xy
# [xy]~p的x坐标的期望值为
E(x) = ∫S|f(x,y)p(x,y)dA = 0101|4x^2ydxdy =  2/3
```

**均值估计(Estimated Means)**  
共享相同密度`p`的随机独立变量`x1,x2{xi}`，这些变量`独立同分布-independent identically distributed(iid)`。  
当它们的总和除以变量数量(如，迭代次数)时，我们得到E(x)的**估计值**。  
```ruby
E(x) ~= 1/N * Σ(i=1..N)xi.
```
随着N的增加，该估计的`Variance(方差-暂)`(略)会减小。我们希望N足够大，以便我们有信心估计值足够接近。然而，蒙特卡洛没有确定的事情；我们只是获得了统计上的信心，相信我们的估计是好的。可以肯定的是，我们必须让`N = INF`。这种信心由大数法(Law of Large Numbers)表达。  

**蒙特卡洛积分**  
本节概述积分的基本蒙特卡洛求解方法。然后，这些技术可以直接应用于某些积分问题。  
根据随机函数期望的定义和估计方法，我们得到以下等式：  
```ruby
E(f(x)) = ∫f(x)p(x)dx         # 像往常一样，最好看成0.1+0.1+...0.9
E(f(x)) ~= 1/N[Σ(i=1..N)f(xi)]
```
这个方程的形式有点尴尬；通常希望近似单个函数`g`的积分，而不是乘积fp。使`f(x)p(x) = g`。  
```ruby
∫S|g(x)dμ ~= 1/N [Σ(i=1..N)g(xi)/p(xi)]
# 为了使该公式有效，当g不为零时，p必须为正
```
因此，为了获得良好的估计，我们需要尽可能多的样本，并且希望g/p具有较低的方差（g和p应该具有相似的形状）。  
智能地选择p称为`重要性采样(importance sampling)`，因为如果p很大而g很大，那么重要区域会有更多的样本。  

方程还显示了蒙特卡洛积分的基本问题：收益递减。由于估计的方差与`1/N`成正比，因此标准差与`1/√N`成正比。由于估计中的误差与标准差的行为类似，因此我们需要将N乘以四倍才能将误差减半。  
减少方差的另一种方法是将积分的域S划分为几个较小的域Si，并将积分评估为Si上的积分之和。即抖动采样/分层采样。  

通常每个Si中只取一个样本。在这种情况下，估计的方差为……(略)  
可以证明，如果所有层具有相同的测量，则分层抽样的方差永远不会高于未分层抽样的方差。  
```ruby
∫Si|p(x)dμ = 1/N ∫S|p(x)dμ
```
图形中分层采样最常见的例子是像素采样的抖动，如我们已经所述。  

作为积分I的蒙特卡洛解的示例，设置`g(x) = x`在(0, 4)上：  
```ruby
I = ∫0..4|xdx = 8
```
函数p的形状对N个样本估计值方差的影响如表所示。表中说明的一个重要原则是分层抽样通常远远优于重要性抽样。  

**选择随机点**  
略。  

---
#### 18. 光
光是一类电磁辐射(能量的传播)，测量通常称为`辐射测量学(radiometry)`。  
我们从能量本身开始，能量单位`焦耳-J`。  
光子具有位置、传播方向和波长`λ(nm)`。光子的速度只取决于传播介质的折射率`c ~ n`。有时频率`f = c/λ`也用于光。这很方便，与λ和c不同，当光子折射到新介质中时，f不会改变。另一个**不变的**是光子携带的能量`q`，由以下关系给出：
```ruby
q = hf = hc/λ
```
`h`普朗克常数(J)。  

**光谱能量**  
对大量光子的能量`pi`求和可以计算总能量`Q`。  
我们可以画出波长间隔内感兴趣的能量分布，例如`q{λ500..600} = 10.2J`。划分越小越详细，我们可以进一步比较不同桶里的能量。  
而然通常的做法是将结果`Δq`(并且依赖于选定波长)除以该波长范围`Δλ`，因此得到一个称为`光谱能量(spectral energy)`的量`Qλ(下标) = Δq/Δλ`。如果这样做，即使在`dλ`减小到比`1nm`小时，感知的量会扩大。例如，此例为`Qλ{500..600} = 0.12J /nm`，尽管取的`dλ`较大，但在较小时仍然具有良好比较效果。  

注意，光谱能量是所谓的`密集量(intensive quantity)`，而不是能量、长度或质量等广延量。密集量可以被认为是密度函数，它告诉无限小点处的广泛量的密度(能量密度)，它不会说该波长的能量`Q = 0`，而是局部测量的一个有意义的量，不至于将光子由波长过滤到无法通过任何光子。  

我们将遵循图形惯例，几乎总是使用光谱能量，而很少使用能量。正确符号带有下标，相反，我们将去掉下标并使用Q来表示光谱能量。

**光谱功率**  
我们需要估计光源的能量持续恒定发送量。该速率即功率。  
单位瓦特，焦耳每秒。100瓦灯泡每秒消耗大约100J的能量。100W的光在一秒钟内产生惊人的1e20个光子。  

`光谱功率(spectral power)`的符号是`Φ(λ)`。计算方式为`Φ=Δq/(ΔtΔλ)`。  
由于我们使用光谱能量再除以时间，功率会均匀平摊到波长上，在较大范围上的结果会比一般的功率更小。  
因为单位是`W(nm)^-1`(瓦每纳米)。  

**辐照度**  
很显然，我们对照射到特定面积上`ΔA`的功率感兴趣。如果问"入射到一点上的功率？当然，"答案是"无"，我们必须观测比极小点稍微大点的东西，即一块小微面，就像我们之前那样做的一样(而不是观测真的波长的夹缝)。但是我们可以确实可以用它来近似为图形中这表面一点的功率。  
这称为`辐照度(irradiance)`。辐照度就是单位面积的功率`ΔΦ/ΔA`，展开为`H = Δq / ΔA*ΔtΔλ`。  
因此，单位是`J/m^2/s/nm`。同时使用纳米和米是因为这些是面积和可见光的自然单位。  

当光**离开表面**时，例如，当它被反射时，与辐照度相同的量称为`出辐照度/出射辐照度(radiant exitance)，E`。对入射光和出射(exitant)光使用不同的词很有用，因为同一点可能具有不同的辐照度和出辐照度。  

**立体角**  
下一个单位需要引入**立体角(solid angle)**`σ`的概念。它是角度概念的延伸。其扩展方式类似于将角度转为弧制(角度 -> 单位圆曲线长度量)的过程。您可以将其视为函数。  
类似地，一个立体角所得到的"弧制"，制式称为`球面度(steradians)`，最大值为`4Pi`。它是单位球体中的立体角向其表面以锥体投影所交的球壳表面积。  
特别小的立体角可视为方向向量，与上述的点辐照度一起使用很方便。  

**辐射度**  
`辐射度(radiance)`将辐照度给出的点表面功率进一步与各个**方向**联系起来，或者说它测量了点上更小立体角`Δσ`方向上的量。  
一个测量结果是：`ΔH/Δσ = Δq/ Δσ* ΔAΔtΔλ`。  
``` ruby
          /radiance
       H /
-------.---------
```
这就是光谱辐射度，记住我们对所有术语省略了光谱一词。
辐射度这个量通常在程序中使用，因为我们可以将他设置成经典着色的半球表面结构上进行参考。  

神奇的是，辐射度的一个奇妙特性是**它不会沿空间线变化**。我们假设点确实具有面积，越近则面积越大，越远则观测面积越小，这一本质导致了这个量始终不变。  

有一个重要问题需要**理解**，就是辐射度确实可以理解成一条光线，计算它相交于平行表面(着色模型中)具体照射的辐射度时，我们又需要从微观角度来看这两个表面积，实际上是不同的，斜向时两个表面积差距更大！如果您想起了朗伯那就太好了，本质上我们也要对此进行矫正。
```ruby
   / /
  /\/
-...------
```
计表面的辐射度值为`... / cos`。即`dot(n, -v)`。本文我们使用角度`θ`表示。  

为了区分点上入射和射出的辐射度，则我们分别定义(离开表面)`Lo出射辐射度(surface radiance)`和(入射表面)`Li入射辐射度(field radiance)`。我们注意不要丢了余弦项。  
```
Lo =ΔE/Δσcosθ && Li =ΔH/Δσcosθ
```

**积分起来**  
一个例子是从出射辐射度导出其他量。因为辐射度是最小的辐射计量。  
```
Hi(p) = ∫all-rayin| Licosθ dσ
                      #矫正项 每条半球光线
# 为了不用特别分辨H、E我们直接加上i,o等表示出入符号，实际上原本的符号有点诡异
```
```ruby
      in in in
       \|/
-------.H-------
```
假设所有入射光线的Li恒定，我们不想直接在球面上积分球面度，因此我们转入它们的二维等效形式`dσ -> sinθ dθdφ`。(它们的球极位系角(a,b))。本质上都是在半球上拾取方向。  
```ruby
H = ∫半球|...dσ
  = ∫∫(θ,φ)|| Licosθsinθ dθdφ
  = PiLi
```
这种关系向我们展示了常数Pi的首次出现。这些因子在辐射测量中经常出现，并且是我们选择测量立体角的方式的产物。  

类似地，表面(而不是点)的功率是积分：  
```ruby
Φ = ∫S | H(p)dA
```
我们没有针对输入功率和输出功率的特殊术语或符号。这种区别似乎还不足以鼓励这种区别。

---
#### BRDF和传输方程
有时必须根据表面的材料属性来缩放或权衡传入的辐射度。  
该因子随入射和出射方向vi和vo变化，通过`双向反射率分布函数(bidirectional reflectance distribution function)(BRDF)`表示。  

**传输方程(Transport Equation)**  
```ruby
Lo(vo)=∫半球入射vi| ρ(i,o) Li(vi)cosθvi dvi
                   #BRDF      # 每条半球入射光线的矫正
```
这通常称为`渲染方程(1986)(rendering equation)`。  

**光度/光子测量学(`photometry`)**  
对于每个光谱辐射量，都有一个相关的**光度测量量**，用于测量该量有多少对人类观察者有用。  

---
#### 23. 全局光照
我们从本文的上下文而不是光线追踪的上下文开始解释。(23.2)我们从完整渲染方程开始：  
```ruby
Lo(vo)=∫半球入射vi| ρ(i,o) Li(vi)cosθvi dvi  # 渲染方程
```
我们想要的是表面朝着给定方向的出射辐射度，例如正好反射到眼睛里的光线。  
那么这个值最后应该是多少？我们希望的是看见光线的期望值(越来越稳定)。这可以通过将右侧积分视为期望值的积分形式来计算，并转为蒙特卡洛方法使用样本和来平均。  
```ruby
∫S|g(x)dμ ~= 1/N [Σ(i=1..N)g(xi)/p(xi)]  # 蒙特卡洛积分


∫S|g(x)dμ -> ∫半球vi|ρ(i,o)Li(vi)cosθvidvi
#              vi{S}      g(vi)       dvi
           ~= 1/N[Σ(i=1..N)gvi/pvi]
```
而然存在的问题是g(vi)中的Li(vi)项，这些光线本身的辐射度从哪里来呢？别忘了我们从递归中散射光线，因此它最终是可以被评估的，并最终来自于光源！  
另外，我们假定使用颜色作为辐射度的直接映射。  
这样的采样问题是，光线在照明的反方向上撞击到较小的灯具体积可能性很小，因为散射的方向很难命中。  

理想漫射表面是朗伯。这种表面对于任何角度而言都权衡完全相同的BRDF值。  
朗伯的BRDF`ρ = self.albedo / Pi`是一个均匀分配后的常数，建议使用`p(vi) = cosθvi / Pi`作为采样密度(这是对朗伯分布密度的推导)。(可见密度混合)。渲染方程抵消余弦和Pi常数变为：  
```ruby
g/p = self.albedo Li(vi)
```

**求和直接照明**  
为了渲染最终图像，强力路径追踪的渲染方程包含计算直接照明部分。  
```ruby
Lo(vo) = ∫ + emmit(vo)
```

**23.3只求解直接照明**  
为了计算从一个灯具（发光物体）到非发光表面的直接光。同样需要求解传输方程。  
而然，采样方式不同，样本、描述样本的密度必须围绕灯具上的随机点展开。  
可以均匀随机选择灯具表面上一点，使用的采样密度为`p_light = 1 / A`。  
```ruby
~= ... / p(dA)
```
这里描述的方式需要使用阴影光线测试障碍，要么贡献，要么贡献为0。测试函数加入到方程中。  
另外我认为要求两个表面的余弦很奇怪，请读者再仔细检查原文的方程吧。这里可能有3个dot。  
```ruby
~= ρ emmit*shadowcast(ray)*Acos1cos2  /lengthsqare(p, light_p)

# 注意p已经被消去
```
