---
layout: page
title:  "混合密度"
author: mosfet
tags: 杂项 渲染器
---
请见[Ray Tracing: The Rest of Your Life](https://raytracing.github.io/books/RayTracingTheRestOfYourLife.html)。这是笔者相关实践的记录。结论部分是不完善的。  
## 测试
<div class="x gr txac">
  <div class="x la flex mg0">
    <div class="x la item6-lg item12 pd0">
      <img src="/assets/i/4-1.png">
    </div>
    <div class="x la item6-lg item12 pd0">
      <img src="/assets/i/4-2.png">
    </div>
  </div>
  <p>图1：完全间接照明(经典情况)、采样混合但只有间接部分</p>
</div>

<div class="x gr txac">
  <div class="x la flex mg0">
    <div class="x la item6-lg item12 pd0">
      <img src="/assets/i/4-3.png">
    </div>
    <div class="x la item6-lg item12 pd0">
      <img src="/assets/i/4-4.png">
    </div>
  </div>
  <p>图2：完全间接照明(经典情况)、采样混合并找到直接光照，光源看上去好多了</p>
</div>

## notes

`g/p = ρLcosθ/p`  
我们要注意ρ(i,o)，以及g/p中的p项，其中p是采样散射的分布。  
朗伯BRDF等于`ρ = self.albedo/Pi`。带入方程，`g/p = L* A/PI dot(n, out) / p`。  
因此我们采样散射线，随机生成。注意我们原来用的朗伯散射生成向量垂直方向本身具有更大概率。  

(5)  
注意他所谓的散射分布，压根就不在方程里。我用`sp`来表示好了。这个散射分布是cos相关的那个。  
现在将该散射分布`sp`推导为**显式函数**。  
散射半球的积分为1，并且朗伯是一个正比函数`sp = C * cosθ`(随着角度具有更大概率或配重)。则很容易给出`C = 1/pi -> sp = cosθ / pi`。有些积分技巧总是可以注意，例如将半球转为二维。  

(6)  
在`albedo *= sp * self.albedo / (1.0 / C_TWO_PI);`中，加入了比率`朗伯sp/均匀采样密度p`，密度均匀。注意我们仍然使用相同的散射方式(n+rd)，这似乎是根本无关的(再次确认无关。图像结果一样，但变亮)。  

接下来改为`p = sp = 1/ 2pi`。并且把散射方式(材料)改为半球反射。结果和半球完全一致(原来的材料)。因为我们只是加了一个等于`1`的比率。  

相同的材料不会影响收敛结果，采样PDF仅影响收敛速度。因为你需要更多样本显示分布差异，结果本身只受材料的散射行为影响。改变材质将从根本上改变渲染，算法将收敛到不同的答案。  

存在的差异不仅仅是"噪音"。高大的盒子正面颜色更加均匀。如果您不确定材质的最佳采样模式是什么，那么继续假设均匀的PDF是相当合理的，虽然这可能会缓慢收敛，但它不会破坏您的渲染。
也就是说，如果您不确定材质的正确采样模式是什么，那么您选择的PDF并不是您最关心的问题，因为错误地选择散射函数会毁掉您的渲染。至少它会产生错误的结果。
您可能会发现自己遇到了蒙特卡罗程序中最难发现的错误 - 产生合理外观图像的错误！您不会知道该错误是在程序的第一个版本中，还是在第二个版本中，或者两者都存在！

(9)  
尽管阴影光线可以解决直接照明。  
但他决定使光线更有可能射向灯光。对于散射而言，直接让散射指向采样的光线。这可能很抽象。  
我们选择指向光源的散射并计算对应的`p`。结果为`sp / lp`。  

`随机采样灯光线(grab-p) -> 计算采样分布 -> /PDF`。  

但我们需要知道`p(v)`，这样我们的渲染就不会产生偏差。但那是什么？  
```ruby
# 最好将点和角度视为微面和微立体角。dA dv，dA比dv的面积大得多，这是有道理的
# 我们通过采样dA(知道其概率)进而采样dv(的概率)，因此可以获得正确的p
P(dA) = 1 / A   # 1/A
p(dv) = ?        #

# 面积dA、dv存在几何关系
dv = dAcosθ / dot(grab-p, grab-p)  # 注意，将其视为面积，而点则只是点，提供距离
# 由于采样概率相同
  p(dv) = p(da)    # 这里可以视为点………
p(dv)dv = p(da)dA

p(dv) = dot(grab-p,grab-p)/ cosθA
```

(10)  
对漫射混合采样(跳过其他材料)。  
`albedo *= sp * material.albedo / (0.5 * (lp + sp));`。  
在直接光散射和漫射散射随机选择一条，总是计算材质的`sp`，最后以此形式混合。再次注意，和项中的`sp = 间接p`，因为它们从实际用的散射方法的分布推导中出来相等。  

(11.12)  
混合密度方法是更传统的阴影光线的替代方法。阴影用于检查从交叉点到给定光源的无障碍路径。混合密度方法还可以对窗户或门下明亮的裂缝或任何您认为可能明亮或重要的东西进行采样。但您仍然会在大多数专业路径追踪器中看到阴影光线。

修复材料镜面反射可以使其作为跳过f()/p()的特殊情况，只需跳过显式的/p()计算。  
对于我们正在镜面处理的材质，我们实际上跳过了所有PDF工作。  
玻璃物体很难很好地渲染，所以我们想为它们制作一个PDF。  

12.3制作金属块的PDF可以减少天花板上的噪音。而且并不是很有趣，所以让我们为玻璃球创建PDF。它速度更快，渲染效果更有趣。  