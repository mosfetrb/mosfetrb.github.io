---
layout: page
title:  "PBR积分理论(译)"
author: mosfet
tags: 杂项 
---
本文翻译了创建PBR所需要的基本理论章节。内容来自于Peter Shirley一书。  

## 空白

---
#### 14. 积分
采样。许多图形应用需要对非寻常空间进行"公平"采样，如充满可能线的空间。  
例如，我们可能需要在像素内生成随机边缘，或像素内的随机样本点，根据其密度，即一些`密度函数(density function)`。  
本章提供了此类概率运算的机制。这些技术对于使用蒙特卡洛积分对复杂积分进行数值计算也很有用，本章也将对此进行介绍。  

积分和测量两个词不应该让人感到生畏，度量函数仅将度量集输出为一个值，意味长度、面积等等。  
实际计算度量只采用积分形式，如下：  
```ruby
∫y1..y2|(∫x1..x2|f(x,y)dx)dy
∫y1..y2|(∫f1(y)..f2(y)|f(x,y)dx)dy
∫∫R|f(x,y)dA        # 正如多重积分中所言，如果S的域是二维的，通常A是域的微面
∫x(∫ydy)dx

A(S)= ∫S|dA
A(S)= ∫x{S}|dA(x)   # 本文使用的形式，可以避免歧义
```
图形学中求解此类积分不是分析的，如果微积分技巧已经消失，请不要担心，因为我们通常必须对积分进行数值近似，而这只需要一些简单的技术，本章稍后将介绍这些技术。  

**配重(weighted)函数**  
可在积分中加入一个非负配重函数来产生新的测量。
```ruby
∫x{(0..1)^2}| dA(x)
          ->  ||x||^2 # 这称为径向配重，该值等于域向量的长度

          # 配重是本文中才第一次出现的数学术语，尚不清楚它应该被归属于哪个领域，可能是概率论。
# 如果您希望采用一般分析方法尝试评估积分，可写成正常形式
∫x=1..0|∫y=0..1|(x^2+y^2) d...
```

**配重倍率**  
现在我们可以算出配重积分对无配重积分的比率，总的来说，它们是相同测量域上产生不同积分结果。  
请注意，我们始终将dA视为微面，那么，最终可能相当于面积扩大或缩小了！这个比率给出总体上的倍率。  
```ruby
average(f(x)) = ∫x{S}f(x)dA(x)
                -----------
                ∫x{S}dA(x)

# 例如，S=(0..2)^2, f(x)= x^2(仅x，非域) ->  4/3
```
一旦我们知道了这一点，剩下的就是为应用选择合适的A。而选择合适的A是棘手的部分。  

**连续性概率(Continuous Probability)**  
许多图形算法使用概率来构造随机样本来解决积分和平均问题。  

随机值向量(在空间中连续)获取某个值时，行为完全由它用来取值分布来描述。  
该分布以与变量相关的`概率密度函数(probability density function)`**x~`p`**定量描述。  
变量`x`在特定间隔内抽出样本的概率是它们的密度概率的和，即以下积分：  
```ruby
Prob(0..1) = ∫0..1 | p(x)dx # 相当于求和概率
# p描述了随机变量取某个值的相对可能性。如果函数的返回值是两倍，则相对有两倍概率

# PDF有两个属性
p(x) >= 0
∫INF| p(x)dx = 1 # 概率之和为1(各种事件)
```

**望值**  
具有PDF分布的随机函数的平均值称为它的`预期/期望值(expected value)`，记为`E(f(x)) = ∫f(x)p(x)dx`。  
期望值可以通过设置f(x) = x来计算。期望值有一个令人惊讶且有用的属性，两个随机变量之和的期望值是这些变量的期望值之和：  
```ruby
# 对于随机变量y和y
E(x+y) = E(x) + E(y)
# 因为随机变量的函数本身就是随机变量，所以这种期望的线性也适用于它们：  
E(fx + gy) = Efx + Egy
```
问题是如果求和的随机变量是相关的（不独立），这个属性是否成立？事实上，无论变量是否独立，这种线性属性都成立！此求和属性对于大多数蒙特卡洛应用至关重要。

**多维随机变量**  
对随机变量及其期望值的讨论自然延伸到多维空间。大多数图形问题都发生在这样的高维空间中。例如，许多照明问题都是在半球表面上表述的。幸运的是，如果我们在随机变量占据的空间上定义一个测量`μ`，一切都与一维情况非常相似。  
假设空间S有相关的测量`μ`；例如`S`是球体的表面积，μ测量面积。我们可以定义一个pdf: S->eachProb，随机向量`x~p`，那么向量在某个区域`Si{S}`中取值的概率由积分给出：  
```ruby
Prob(x{Si}) = ∫Si | p(x)dμ
```
这里的概率（事件）是事件为真的概率，因此积分是在子区域Si中取值的概率。  
图形中S通常是一个面积dμ=dA=dxdy或一组方向dμ=dω=sinθ dθdφ。  

举个例子，二维随机变量`α`是半径为R的圆盘上均匀分布的随机变量。这里均匀意味着面积均匀，例如，糟糕的飞镖运动员的命中在飞镖板上的分布方式。由于它是均匀的，我们知道p(α)是某个常数。根据圆盘面积为Pir^2且总概率为1的事实，我们可以推出：  
```ruby
p(α) = 1/ PiR^2    # 平均相同的概率
# 这意味着α在磁盘的某个子集S1中的概率为，
Prob(α{S1}) = ∫S1 1/PiR^2 dA.
# 这一切都非常抽象。为了实际使用这些信息，我们需要可以计算的形式的积分
# 假设Si是圆盘上比周边更靠近中心的部分
# 如果转换为极位系(polar coordinates)，则α表示为(r, φ)对，S1为 r<R/2 的区域
# 请注意，仅仅因为α是均匀的，并不意味着φ或r一定是均匀的（事实上，φ是均匀的，而r是不均匀的）。
# 微面测量面积dA就是r dr dφ
# 因此
Probability(r < R/2) = ∫0..2pi∫0..R/2 1/piR^2 rdrdφ = 0.25
```
```ruby
# 函数的期望值的公式适用于多维情况：
E(f(x)) = ∫S|f(x)p(x)dμ
# 其中x{S}, f: S->R && p: S->R

# 例如，在单位正方形
S=0..1^2 && f(x,y)=x && p(x, y)=4xy
# [xy]~p的x坐标的期望值为
E(x) = ∫S|f(x,y)p(x,y)dA = 0101|4x^2ydxdy =  2/3
```

**估计均值**  
许多问题涉及独立随机变量`xi`(指的是一次迭代的x)的总和，所有产生的变量共享一个公共密度p。则称这些变量`独立同分布-independent identically distributed(iid)`随机变量。  
当总和除以变量数量(迭代次数)时，我们得到E(x)的估计值。  
```ruby
E(x) ~= 1/N * Σ(i=1..N)xi.
```
随着N的增加，该估计的`Variance(方差-暂)`(略)会减小。我们希望N足够大，以便我们有信心估计值足够接近。然而，蒙特卡洛没有确定的事情；我们只是获得了统计上的信心，相信我们的估计是好的。可以肯定的是，我们必须让`N = INF`。这种信心由大数法(Law of Large Numbers)表达。  

**蒙特卡洛积分**  
本节概述积分的基本蒙特卡洛求解方法。然后，这些技术可以直接应用于某些积分问题。  
如前所述，给定函数f: S->R和随机变量x~p，我们可以通过总和来近似f(x)的期望值：  
```ruby
E(f(x)) = ∫x{S}| f(x)p(x)dμ ~= 1/N Σ(i=1..N)f(xi)
```
由于期望值可以表示为一个积分，而积分可以通过总和来近似。这个方程的形式有点尴尬；我们通常希望近似单个函数g的积分，而不是乘积fp。我们可以通过将其替换为积分函数来实现这一点。  
```ruby
∫x{S}| g(x)dμ ~= 1/N Σ(i=1..N)g(xi)/p(xi)
# 为了使该公式有效，当g不为零时，p必须为正
```
因此，为了获得良好的估计，我们需要尽可能多的样本，并且希望g/p具有较低的方差（g和p应该具有相似的形状）。  
智能地选择p称为`重要性采样(importance sampling)`，因为如果p很大而g很大，那么重要区域会有更多的样本。  

方程还显示了蒙特卡洛积分的基本问题：收益递减。由于估计的方差与`1/N`成正比，因此标准差与`1/√N`成正比。由于估计中的误差与标准差的行为类似，因此我们需要将N乘以四倍才能将误差减半。  
减少方差的另一种方法是将积分的域S划分为几个较小的域Si，并将积分评估为Si上的积分之和。即抖动采样/分层采样。  

通常每个Si中只取一个样本。在这种情况下，估计的方差为……(略)  
可以证明，如果所有层具有相同的测量，则分层抽样的方差永远不会高于未分层抽样的方差。  
```ruby
∫Si|p(x)dμ = 1/N ∫S|p(x)dμ
```
图形中分层采样最常见的例子是像素采样的抖动，如我们已经所述。  

作为积分I的蒙特卡洛解的示例，设置g(x)在(0, 4)上等于x：  
```ruby
I = ∫0..4|xdx = 8
```
函数p的形状对N个样本估计值方差的影响如表所示。表中说明的一个重要原则是分层抽样通常远远优于重要性抽样。  

**选择随机点**  
略。  

---
#### 18 光
`辐射测量学(radiometry)`测量电磁辐射。精确定量光。  
光从根本上来说是一种能量的传播形式，能量单位`焦耳-J`非常有用。  
光子具有位置、传播方向和波长`λ(nm)`。光子的速度只取决于传播介质的折射率`c ~ n`。有时频率`f = c/λ`也用于光。这很方便，与λ和c不同，当光子折射到新介质中时，f不会改变。另一个不变的是光子携带的能量`q`，由以下关系给出：`q = hf = hc/λ`，`h`普朗克常数。  

如果我们有大量光子，它们的总能量`Q`可以通过对每个光子的能量`qi`求和来计算。一个合理的问题是“能量如何在波长上分布？”回答这个问题的一个简单方法是将光子划分到箱中，例如，`Qλ(500.600) = 10.2J`。依此类推。该系统的优点在于它很简单。其不好之处在于间隔大小的选择决定了数量。更常用的系统是将能量除以间隔的大小。因此，`10.2/100`。这种方法很好，间隔影响要小得多。一个直接的想法是将间隔大小钳至零。这可能会很尴尬，Q将为零或很大，具体取决于间隔中是否有单个光子或没有光子。有两种思想流派可以解决这个困境。首先是假设λ不会小到光的量子性质发挥作用。第二个是假设光是连续谱而不是单个光子，因此真正的微斜度`dQ/dλ`是合适的。两种思考方式都是合适的，并且会产生相同的计算机制。在实践中，大多数测量光的人似乎更喜欢小但有限的间隔，因为这是他们可以在实验室中测量的。大多数从事理论或计算的人更喜欢差分。  
量`Qλ`称为`光谱能量(spectral energy)`，它是一个`密集量(intensive quantity)`，不是能量、长度或质量等广延量。密集量可以被认为是密度函数，它告诉无限小点处的广延量的密度。例如，特定波长处的能量**Q**可能为零，但光谱能量（能量密度）Qλ是一个有意义的量。一个可能更熟悉的例子是，一个国家的人口可能有2500万，但那个国家某一点的人口是没有意义的。然而，只要在足够大的区域内进行测量，人口密度是有意义的。我们将遵循图形惯例，**其中几乎总是使用光谱能量**，而很少使用能量。如果使用“正确”的符号，这会导致`λ下标`的激增。相反，我们将去掉下标并使用**Q**来表示光谱能量。这可能会导致一些混乱，因此请注意这个标准问题。想象一个带有测量光能`Δq`的传感器的测量设备可能会有助于您对光谱能量的直觉。如果在传感器前面放置一个彩色滤光片，仅允许`λ-Δλ/2 .. λ+Δλ/2`内的光通过，则λ处的光谱能量为`Q = Δq/Δλ`。  

估计光源的能量产生密度很有用。称为功率，瓦特每秒焦耳。这在稳定状态下最容易理解，但功率是一个密集量（随时间变化的密度），因此即使能源产量随时间变化，它也能得到很好的定义。100瓦灯泡每秒消耗大约100J的能量。100W的光在一秒钟内产生了多少光子。假设产生的平均光子的能量为λ =500nm光子。这种光子的频率是f=c/λ = 6e14。能量为hf ≈ 4e-19J。这意味着即使灯泡的效率不是很高，每秒也会产生惊人的1e20个光子。与能量一样，我们真正感兴趣的是以`W (nm)^-1(瓦每纳米`)测量的`光谱功率(spectral power)`。同样，虽然光谱功率的正式标准符号是`Φλ`，但为了方便和与大多数图形文献保持一致，我们将使用不带下标的**Φ**。需要注意的一件事是，光源的光谱功率通常比功率更小。例如，如果光发出100W的功率，均匀分布在400nm至800nm的波长上，则光谱功率将为100W/400nm = 0.25W(nm)^-1 。如果您出于调试目的手动设置光源的光谱功率，则需要记住这一点。上一节中的光谱能量测量装置可以通过用以时间`t`为中心的时间间隔`Δt`打开的快门读取读数来修改。光谱功率将为`Φ=Δq/(ΔtΔλ)`。  

`辐照度(irradiance)`。如果你问"有多少光照射到这一点？"这个问题，量辐照度自然会出现。当然，答案是"无"，我们必须再次使用密度函数。如果该点位于曲面上，则很自然地使用面积来定义我们的密度函数。我们修改了上一节的设备，使其具有小于被测量光场(light field)的有限`ΔA`面积传感器。`光谱辐照度H(spectral irradiance)`就只是每单位面积的功率`ΔΦ/ΔA`。完全展开后是这样的`H = Δq / ΔA*ΔtΔλ`。因此，辐照度的完整单位是Jm^-2s^-1(nm)^-1。请注意，radiance的单位包括单位包括面积的倒数米平方和波长的倒数纳米。这种看似不一致（同时使用纳米和米）是因为这些是面积和可见光的自然单位。  
当光**离开表面**时，例如，当它被反射时，与辐照度相同的量称为`出辐照度/出射辐照度(radiant exitance)，E`。对入射光和出射(exitant)光使用不同的词很有用，因为同一点可能具有不同的辐照度和出辐照度。  

下一个单位需要**立体角(solid angle)**`σ`的概念，它是角度概念的延伸。其扩展方式类似于将角度转为弧制(曲线长度)的过程。它用球体射出的锥体所交球体表面面积的大小表示立体角度，制式称为`球面度(steradians)`，最大值为`4Pi`。  

`辐射度(radiance)`。尽管辐照度告诉我们有多少光到达某个点，但它却告诉我们很少关于光来自的**方向**。为了测量类似于我们用眼睛看到的东西，我们需要能够将"多少光"与特定方向联系起来。我们可以想象一个简单的设备来测量这样的量（图 18.1）。我们使用一个小型辐照度计并添加一个圆锥形"挡板"，将撞击柜台的光线限制在立体角**Δσ**的角度范围内。检测器的响应如下：`ΔH/Δσ = Δq/ Δσ* ΔA Δt Δλ`。  
``` ruby
   / Δσ
ΔA|
   \ Δσ
```
这是光在空间中旅行的光谱辐射度(spectral radiance)。再次，我们将在讨论中放弃"光谱spectral"并假设它是隐含的。  
辐射度是我们通常在图形程序中计算的。辐射度的一个奇妙特性是它不会沿空间线变化。要了解为什么会出现这种情况，请检查两个辐射探测器，它们都观察一个表面，如图18.2 所示。假设探测器所观察的线足够近，以至于表面在两个被测量的区域中发射/反射的光“相同”。因为被采样表面的面积与距离的平方成正比，并且因为到达检测器的光与距离的平方成反比，所以两个检测器应该具有相同的读数。  
(18.2)辐射检测器(radiance detector)接收的信号不取决于到被测量表面的距离。该图假设探测器指向表面上以相同方式发光的区域。  

测量照射到表面的辐射度很有用。我们可以考虑将辐射检测器的锥体挡板放置在表面上的一点，并测量表面上源自锥体内方向的辐照度**H**（图18.3）。请注意，表面"探测器"未与锥体对齐。(18.3)锥体遮蔽的表面处的辐照度比探测器处测量的辐照度小一个余弦因子。因此，我们需要在辐射度的定义中添加一个余弦校正项：`respond = ΔH/Δσ cosθ = Δq /ΔA cosθ Δσ Δt Δλ`。  
与辐照度和出辐照度一样，区分表面上某一点的入射辐射度和从该点出射的辐射度非常有用。有时在图形文献中使用的这些概念的术语是
`表面辐射度(surface radiance Ls)`(离开表面)和`场辐射度(field radiance Lf)`(入射表面)。两者都需要余弦项，因为它们都对应于图18.3中的配置：  
```ruby
Ls = ΔE/Δσ cos θ
Lf = ΔH/Δσ cos θ
```

辐射度和其他辐射量：  
如果我们有一个表面，其场辐射度为**Lf**，那么我们可以从中导出所有其他辐射量radiometric quantities。这是辐射度被认为是基本fundamental辐射量的原因之一。例如，辐照度可以表示为  
```
H = ∫all-k| Lf(k)cosθ dσ
```
该公式具有图形中常见的几种符号约定，这使得这些公式对于不熟悉它们的读者来说不透明（图18.4）。  
首先，`k`是入射方向，可以被认为是相对于表面标准向量的球极位系中的单位向量、方向或(θ, φ)对。(18.4)该方向K方向有一个与其相关的微立体角dσ。  每个方向的场辐射度可能不同，因此我们将其写为函数`L(k)`。
例如，我们可以计算在所有方向上具有**恒定场辐射度Lf**(非函数)的表面的辐照度H。为了积分，我们使用经典的球极位系并回想一下差分立体角是`dσ ≡ sinθ dθ dφ`
所以辐照度是：    
```ruby
H = ∫φ0..2pi∫θ0..pi/2 || Lfcosθsinθ  dθdφ = piLf
```
这种关系向我们展示了一个可能令人惊讶的常数PI的首次出现。这些PI因子在辐射测量中经常出现，并且是我们选择测量立体角的方式的产物，即单位球体的面积是PI的倍数而不是1的倍数。  
类似地，我们可以通过积分整个表面区域的辐照度来找到击中表面的功率：  
```ruby
Φ = ∫allx | H(x)dA
```
其中`x`是表面上的点，`dA`是与该点相关的微面积。请注意，我们没有针对输入功率和输出功率的特殊术语或符号。这种区别似乎还不足以鼓励这种区别。

---
#### BRDF 18.1.6
因为我们对表面外观感兴趣，所以我们想要表征表面如何反射光。在直观层面上，对于来自方向`ki`的任何入射光，在出射方向`ko`(outgoing direction)附近的一个小立体角中会产生一些散射。我们可以通过多种方法来形式化这样的概念，毫不奇怪，这样做的标准方法是受到构建一个简单的测量设备的启发。
这样的设备如图18.5所示，其中一个小光源位于从表面上的点看去的方向ki上，探测器位于方向ko上。对于每个方向对(ki，ko)，我们用探测器读取读数。  

图 18.5。一种简单的定向反射率测量装置。**光和检测器的位置移动到每对可能的方向**。请注意，ki和ko都指向远离表面的方向，以实现互易。  
Figure 18.5. A simple measurement device for directional reflectance. The positions of light and
detector are moved to each possible pair of directions. Note that both ki and ko point away from the
surface to allow reciprocity.  

现在我们只需要决定如何测量**光源的强度**并使我们的反射函数独立于该强度。例如，如果我们用更亮的光替换光，我们就不希望认为表面以不同的方式反射光。  
我们可以在被照射的点放置一个辐射计来测量光。然而，为了在此情况下获得准确读数，而无关探测器可能所使用的Δσ，我们需要光线所面对subtend的立体角大于Δσ。
不幸的是，我们的流动roving辐射探测器在ko方向上得到的测量也会将，来自新探测器锥体外的点的光纳入计量。所以这似乎不是一个实际的解决方案。  

或者，我们可以将辐照度计放置在被测量表面的点处。这将需要一个不太依赖于光源几何形状的微妙之处的读数。这建议将**反射率(reflectance)**表征为一个比率：`ρ = Ls/H`。  
其中反射率`ρ`将随入射和出射方向ki和ko变化，H是ki的辐照度，Ls是在ko方向上测量的表面辐射度。如果我们对所有方向对进行这样的测量，我们最终会得到4D函数`ρ(ki, ko)`。该函数称为`双向反射率分布函数(bidirectional reflectance distribution function)(BRDF)`。我们用BRDF表征表面如何反射光的方向特性。  

**Directional半球反射率**  
给定BRDF，很容易就会问：入射光的哪一部分被反射了？然而，答案并不那么容易；反射部分取决于入射光的方向分布。由于这个原因，我们通常仅为固定(fixed)入射方向ki设置反射部分(fraction reflected)。该分数称为`半球反射率(directional hemispherical reflectance)`。该分数`R(ki)`定义为：  
```ruby
Rki = power in all outgoing directions ko
      ---
      power in a beam from direction ki
```
请注意，出于能量守恒的原因，该量介于0和1之间。如果我们让入射功率Φi照射在一个小区域ΔA上，那么辐照度就是Φi/ΔA。
进一步的，功率的比率就是出辐照度与辐照度的比率`R(ki) = E/H`。此功率造成的特定方向的辐射度由BRDF定义：
`L(ko) = Hρ(ki, ko) = Φi/ΔA` 根据辐射度的定义，我们也有`L(ko) = ΔE / Δσo cosθo`，E是ko方向上小补丁patch的出射辐照度。使用这两个辐射度定义，我们得到
`Hρ(ki, ko) = ΔE/Δσo cosθo`，重新排列术语，我们得到`ΔE/H = ρ(ki, ko)Δσo cosθo`。  
这只是特定ko附近反射的对E/H的小贡献。为了找到总R(ki)，我们求和所有outgoing ko。积分形式是：  
```ruby
R(ki) = ∫allko | ρ(ki, ko)cosθo dσo
```

**理想漫反射BRDF**  
理想化的漫反射表面称为朗伯(Lambertian)。由于热力学原因，这样的表面在自然界中是不可能的，但从数学上讲，它们确实节省了能量。  
朗伯BRDF有一个等于常数的ρ，对于所有角度。这意味着表面对于所有视角都将具有相同的辐射度，并且该辐射度将与辐照度成正比。
如果我们为一个朗伯表面，具有**p=C**的，计算其R(ki)，我们得到：  
```ruby
R(ki) =∫allko | C cosθo dσo = ∫φo0..2pi∫θo0..PI/2 || C cosθo sinθo dθo dφo = PI C
```
因此，对于完美反射的朗伯表面(R = 1)，我们有`ρ = 1/PI`，对于有R(ki) = r的朗伯表面，我们有`ρ(ki, ko) = r/PI`;
这是另一个例子，其中使用立体角的球面度来确定归一化常数，从而引入PI因子。

**18.2 传输方程(Transport Equation)**  
根据BRDF的定义，我们可以以所有不同方向的入射辐射度的术语描述一表面的辐射度。因为在图形学中可以使用理想化的数学，但在实验室中实例化可能不切实际，我们同样可以写出BRDF，仅以术语辐射度的形式。如果我们采取一部分的光，即用立体角Δσi以及辐射度Li，然后测量反射的辐射度，在ko方向上，那是根据该小块光产生的，则我们能计算BRDF（图18.6）。  
Figure 18.6. The geometry for the transport equation in its directional form  
图18.6。传输方程的方向形式，几何；  
```ruby
        / -ki
       v 指向锥体
         
ko n /θi cone(dσ)
 \ |/ 
---.---
```

小片光线产生的辐照度是`H = Li cosθi Δσi`，因此BRDF是`ρ = Lo/ Licosθi Δσi`。  
这种形式在某些情况下很有用。重新排列术语，我们可以写出ki方向来的光线产生的辐射率的一部分。  
```ruby
ΔLo = ρ(ki, ko)Li cosθi Δσi
```
如果有来自多个方向的光Li(ki)，我们可以将它们全部相加。积分形式中，以表面和场辐射度的表示法表示，  
```ruby
Ls(ko)=∫allki | ρ(ki, ko)Lf(ki) cosθi dσi.
```
这通常称为`渲染方程(1986)(rendering equation)`。  

有时仅根据表面辐射度来编写传输方程很有用。请注意，在封闭环境中，来自某个表面的场辐射度Lf(ki)，其表面辐射度`Ls(-ki) = Lf(ki)`（图 18.7）。  
Figure 18.7. The light coming into one point comes from another point.  
图18.7。进入一点的光线来自另外一点。  
```ruby
         \
      N  .X
     θ2  / \
        -ki
  n θi ki
  |/
-.x---
```

图中X点所对的立体角由下式给出`Δσi = ΔA2 cosθ2 / ||x-X||^2`，其中`ΔA2`是与`X`关联的面积。将Δσi替换为含ΔA2的形式得到以下建议的传输方程：  
```ruby
Ls(x, ko) = ∫all X visible to x| [ρ(ki, ko)Ls(X,x-X) cosθi cosθ2 / ||x-X||^2]  dA2
```
请注意，我们使用非归一化向量`x − X`来指示从X到x的方向。另请注意，我们将Ls写为关于位置和方向的函数。  
这个新方程的唯一问题是积分的域很尴尬。如果我们引入可见性函数，我们可以权衡域的复杂性和积分函数的复杂性：  
```ruby
Ls(x, ko) = ∫allX| [ρ(ki, ko)Ls(X,x-X) v(x,X) cosθi cosθ2 / ||x-X||^2 ] dA2
v(x,X) = 1 如果 x,X 相互可见
         0          否则
```

**18.3 `光度/光子测量学(photometry)`**  
对于每个光谱辐射量，都有一个相关的光度测量量，用于测量该量有多少对人类观察者有用。  

---
#### 23. 全局光照
我们从本文的上下文而不是光线追踪的上下文开始解释。(23.2)我们从完整传输方程开始：  
```ruby
Ls(ko)=∫allki | ρ(ki, ko)Lf(ki) cosθi dσi.
Ls(ko)=Le(ko) + ∫allki | ρ(ki, ko)Lf(ki) cosθi dσi.
# 传输几何结构如18.6相同
```
使用蒙特卡洛积分近似求解每条光线的该方程。在之前我们提到，可以通过随机样本近似积分。  
```ruby
∫x{S}|g(x)dμ ~= 1/N Σ(i=1..N)g(xi)/p(xi)
```
其中xi是具有**概率密度函数p**的随机点。我们直接将其应用到`N = 1`的传输方程中，我们会得到  
```ruby
Ls(k0) ~= Le(ko)+ (ρ(ki, ko)Lf(ki)cosθidσi  /p(ki))
```
因此，如果我们有办法选择具有已知密度p的随机方向ki，我们就可以获得估计值。问题是Lf(ki)本身是一个未知数。幸运的是，我们可以应用递归并通过向该方向发送射线来使用Lf(ki)的统计估计来找到在该方向上看到的表面。当我们击中灯具且Le不为零时，我们就结束了。方法假设光的反射率为零，否则我们将继续递归。  
对于朗伯BRDF(ρ = R/PI)，我们可以使用余弦密度函数`ρ(ki)=cosθi / PI`；  
可以根据这些方程选择具有该密度的方向。这允许在我们的估计中取消一些余弦项，`Ls(ko) ~= Le(ko) + RLf(ki)`。  

(这类似于我们已经实现的深度散射的朗伯反射)。  
除非使用大型灯具或大量样本，否则这将导致图像噪声非常大。灯具的颜色远高于1以使表面的最终颜色接近1，因为只有那些偶然照射到灯具的光线才会做出贡献，而大多数光线只会做出贡献接近于零的颜色。如果存在天空灯具，通常不会全黑，但尽管如此我们仍然不能实际解决灯光的采样问题，这对于真实度而言是非常不合理的。  
在一般情况下，我们可能想要使用光谱颜色或更通用的BRDF。在实践中，我们应该让材质类包含成员函数来计算随机方向以及计算与该方向关联的p。通过这种方式，可以将材料透明地添加到实现中。  

**23.3精确的直接照明**  
这些方法将有助于使全局照明算法更加高效。关键思想是将阴影光线发送到灯具，但要根据上一章中的传输方程仔细记录。  
可以调整全局照明算法，以确保它们只计算一次直接分量。例如，在粒子追踪中，不会记录直接来自灯具的粒子，因此可分离间接编码。这使得漂亮的阴影比在全局照明的背景下计算直接照明更有效。  

为了计算从一个灯具（发光物体）到非发光表面的直接光，我们求解前面传输方程的一种形式：
```ruby
Ls(x, ko) = ∫allX| [ρ(ki, ko)Le(X,-ki) v(x,X) cosθi cosθ2 / ||x-X||^2 ] dA2

```
回想一下，Le是光源发射的辐射度，v是可见性函数，如果x看到X则等于1，否则等于0，其他变量如图23.5所示(直射，与之前的一样，但在x处多了一条ko)。  
如果我们要使用蒙特卡洛积分对方程进行采样，我们需要在灯具表面上选取一个具有密度函数p的随机点X（所以X~p）。只需用一个样本代入方程 (14.5)即可得出：  
```ruby
Ls(x, ko) ~= p(ki,ko)Le(X,-ki)v(x,X)cosθicosθ2 / p(X)||x-X||^2
```
如果我们在灯具上选择一个均匀的随机点，则`p = 1/A`，其中A是灯具的面积。这给出了：  
```ruby
Ls(x, ko) ~= p(ki,ko)Le(X,-ki)v(x,X)Acosθicosθ2 / ||x-X||^2

# 23.6
```
我们可以使用此方程以简单的方式对平面（例如矩形）灯具进行采样。我们只需在每个灯具上随机选择一个点。  

```ruby
函数：计算x处反射的ko上的辐射度

从光源上随机选择有标准向量N的一点X，

d = X-x
ki = norm(d)

如果阴影光线没有被遮挡……
遮挡，返回0，
```

23.3.2 对球形灯具进行采样  
虽然可以使用公式23.6对中心为c、半径为R的球体进行采样，但这种采样将产生噪声非常大的图像，因为许多样本将位于球体的背面，并且cosθ术语变化很大。相反，我们可以使用更复杂的p(X)来减少噪声。  
我们可能尝试的第一个非均匀密度是`p(X)∝cosθ2`。事实证明，这与使用`p(X)∝cosθ2/||x'-x||^2`采样一样复杂，因此我们在此讨论。我们观察到，以这种方式对灯具进行采样是……  

23.3.3 非漫射灯具
灯具的亮度没有理由不能随方向和位置而变化。例如，如果灯具是电视，则它可能随位置而变化。  
它会随着汽车前灯和其他定向光源的方向而变化。我们的分析与前面的部分相比几乎不需要改变，除了Le(X) 必须更改为Le(x, -ki)。随方向改变强度的最简单方法是使用相对于N的类Phong的图案。为了避免在总光输出项中使用指数，我们可以使用以下形式  
```ruby
Le(X,-ki) = (n+1)E(X)/2PI   (cos^n-1)θ2
```
`E(X)`是X点的出辐照度，n是Phong指数。当n=1时，您会得到漫射光。如果光在其区域内不均匀，例如电视机，则E将不是常数。  


尾声
 • 我的像素值不再处于某个合理的 0 到 1 范围内。我应该展示什么？
您应该使用第 21 章中描述的一种音调再现技术。

• 实践中使用了哪些全局照明技术？
通常使用一级反射的路径追踪。

• 为什么大多数算法使用传统光线追踪来计算直接照明？
尽管全局照明算法会自动计算直接照明，而且事实上，让它们仅计算间接照明稍微复杂一些，但单独计算直接照明通常会更快。这有三个原因。  
首先，与直接照明相比，间接照明往往更平滑（参见图 23.1），因此可以使用更粗糙的表示。第二个原因是光源往往很小，并且在“从眼睛”的方法（例如路径追踪）中很少会偶然击中光源，而直接阴影光线则非常有效。第三个原因是直接照明允许分层采样，因此与非分层采样相比收敛得很快。分层问题是在 Metropolis Light Transport 中使用阴影光线的原因，尽管其处理直接照明的默认技术仅作为一种要处理的路径类型具有稳定性。  

• 如何对带有金属反射器的灯丝（其中大部分光从灯丝反射）之类的物体进行采样？
通常，整个光被一个近似其聚合行为的简单光源所取代。为了观察光线，使用了复杂的光源。因此，汽车前灯对于观察者来说看起来很复杂，但照明代码可能会看到简单的盘形灯。
• 像天空这样的东西不就是一个灯具吗？
是的，您可以将其视为一个整体。然而，如此大的光源可能无法通过直接照明得到帮助；蛮力技术可能效果更好。
